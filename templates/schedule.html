{% extends "base.html" %}
{% import "macros.html" as macros %}
{% block main %}
{% set schedule = load_data(path="data/schedule.toml") %}
{% set content = load_data(path="data/content.toml") %}
{% set readings = load_data(path="data/reading.toml") %}
{% set lessons = get_section(path="lesson/_index.md") %}

<h1>{{ page.title }}</h1>


{% set count = schedule.days | length %}
{% set class_count = content.classes | length %}
<table class="schedule">
  <tbody>
    {% set_global class_idx = 0 %}
    {% for idx in range(end=count) %}
    {% set day = schedule.days[idx] %}
    <tr class="{% if day.canceled %}canceled{% endif %} {% if day.mon %}mon{% endif %}">
      <th scope="row" class="short num">
        <span class="month {% if day.month %}first{% endif %}">
          {{ day.date | split(pat=" ") | nth(n=0) }}
        </span>
        <span class="day">
          {{ day.date | split(pat=" ") | nth(n=1) }}
        </span>
      </th>
      <td>
      {% if day.event %}
      <strong>{{ day.event | markdown(inline=true) | safe }}</strong>
      {% else %}
      {% if class_idx < class_count %}
      {% set collapse = day.collapse | default(value=1) %}
      {% for collapse_idx in range(end=collapse) %}
      {% set class = content.classes[class_idx] %}
      {% set_global class_idx = class_idx + 1 %}
      <div class="class">
        {% if class.lesson %}
        <b>{{ macros::lesson_link(id=class.lesson, title=true) }}</b>
        {% endif %}
        <b>{{ class.title | default(value='') }}</b>
        {% if class.leader %}({{class.leader}}){% endif %}
        {% if class.readings %}
        <ul>
        {% for rdkey in class.readings %}
          {% set reading = readings[rdkey] %}
          <li>
            <a href="{{reading.link}}">{{reading.name}}</a>
            {% if reading.author %}
            <br><span class="paper-author">{{ reading.author }}</span>
            {% endif %}
            {% if reading.venue %}
            <span class="venue-tag">{{ reading.venue }}</span>
            {% endif %}
            {% if class.paper_slides %}
            <br><a class="schedule-btn slides" href="{{class.paper_slides}}">slides</a>
            {% endif %}
            {% if class.blog_link %}
            <a class="schedule-btn blog" href="{{class.blog_link}}">blog post</a>
            {% endif %}
          </li>
        {% endfor %}
        </ul>
        {% endif %}
      </div>
      {% endfor %}
      {% endif %}
      {% endif %}
      </td>
      <td class="short">
      <ul class="simple">
      {% for note in day.notes | default(value=[]) %}
        <li>{{ note | markdown(inline=true) | safe }}</li>
      {% endfor %}
      {% for lesson in lessons.pages %}
      {% if lesson.extra.due | default(value='') == day.date %}
        <li>Due:
        {% if not lesson.draft %}<a href="{{lesson.permalink}}">{% endif %}Lesson {{lesson.slug}}{% if not lesson.draft %}</a>{% endif %}
        tasks.</li>
      {% endif %}
      {% endfor %}
      </ul>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
(function() {
  var months = {January:0, February:1, March:2, April:3, May:4, June:5,
                July:6, August:7, September:8, October:9, November:10, December:11};
  var rows = document.querySelectorAll('.schedule tbody tr');
  var today = new Date();
  today.setHours(0,0,0,0);
  var found = false;
  for (var i = 0; i < rows.length; i++) {
    var th = rows[i].querySelector('th');
    if (!th) continue;
    var monthEl = th.querySelector('.month');
    var dayEl = th.querySelector('.day');
    if (!monthEl || !dayEl) continue;
    var monthText = monthEl.textContent.trim();
    var dayText = dayEl.textContent.trim();
    if (!monthText || !dayText) continue;
    var m = months[monthText];
    if (m === undefined) continue;
    var d = parseInt(dayText, 10);
    if (isNaN(d)) continue;
    var classDate = new Date(2026, m, d);
    if (classDate >= today) {
      rows[i].classList.add('upcoming');
      found = true;
      break;
    }
  }
})();
</script>
{% endblock main %}
